os:
  - linux
  - osx
  - windows
language: rust
rust:
  - stable
  
# https://levans.fr/rust_travis_cache.html
cache:
  directories:
    - /home/travis/.cargo
before_cache:
  - rm -rf /home/travis/.cargo/registry
  
before_install:
  - rustup toolchain add nightly
  - rustup component add clippy --toolchain=nightly
  - rustup component add rustfmt
 
script:
  - cargo test --verbose --workspace
  - cargo +nightly clippy
  - cargo fmt -- --check
  - cargo run
  - cargo run -- .

before_deploy:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then export TARGET=x86_64-unknown-linux-musl  ; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get update && sudo apt-get -y install musl-tools  ; fi
  
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export TARGET=x86_64-apple-darwin  ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then export MACOSX_DEPLOYMENT_TARGET=10.7  ; fi

  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then export TARGET=x86_64-pc-windows-msvc  ; fi
  
  - rustup target add $TARGET
  - cargo build --release --target $TARGET
  - cp target/$TARGET/release/rpg-cli "rpg-cli-$TRAVIS_OS_NAME-$TRAVIS_TAG"
deploy:
  provider: releases
  api_key:
    secure: "SpQu33o7oIV+Qqg5860UM/z93VX0p8/oD313LwqyB7S7r9d2f054+Ya9fsMM+WcOC3Sm9ouTaTAHOfhpck1VVQgDOg3S1nVzPtXUNU55tX/yzz5cMd14ylfQf1kwv0A3EdU8E9tsrSmgBDhVeOEVt7yEfyFZ5SKh4owkNux0JwvqAE+sP2KCdMfKw9pLfSXA40MvKsTKSszjFFgwX3mC1jMNvNLLsnXk2jM/VMYNMPPvWnOegPDsLQVxSiLWJmZKGagVh25dkGuh1miFeX680yCWvozQSyni6+mkgfTsdG48WhUr9Ojw5/eRSvEQp50S76dz2ibDr11gbOYwg3B4a4xpOPhsQAAAaLReR59yoDAg5pfBFWu/+Y9vzmiuIltesgOTHyWqaW9M2RhZyJFWrR6Vc6oggtKPQP1d4mFTz7qD9z/UwPQysVZ7ArP3amd1803V2w2hpVMJqnu3hcgirb5ya4aXZIMOAgTA8hcIQKSbQpo86x1Z+PFpMoJ5/PAT4Jl6g5eUbOrrpn9NRVU62D6Xe2NqGS8zVLldBQQCWA+JPmtKe50borl6J5w73YubitpQCRpr1y2C4vxV6C0tEml2TNlACKlhhi6hIOPmuiGRCtZQWsNtuxzUeKECsldTTs5TuX3y/LDdjUEw8F/ODdSw13Qwgi3QD8yEheaGIWg="

  file: "rpg-cli-$TRAVIS_OS_NAME-$TRAVIS_TAG"
  skip_cleanup: true
  draft: true
  on:
    # FIXME uncomment, remove draft & branch, set tags: true
    branch: github_releases
  
